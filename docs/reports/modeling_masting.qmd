---
title: "Modeling masting"
subtitle: "From individual tree behavior to population-level synchrony"
toc: false
number-sections: true
highlight: pygments
pdf-engine: pdflatex
format:
  html:
    html-math-method: katex
    theme:
      - lux
      - custom.scss
    standalone: true
    embed-resources: true
    code-overflow: wrap
    linkcolor: "#B97C7C"
    fontsize: '11pt'
    code-block-border-left: "#8F2727"
    code-block-bg: "#f8f8f8"
    highlight-style: github
  pdf:
    keep-tex: true
    code-overflow: wrap
    monofont: 'Latin Modern Mono'
    monofontoptions:
      - Scale=0.9
    include-in-header:
      - text: |
          \usepackage{bm}
          \usepackage{xcolor}
          \definecolor{mid}{HTML}{B97C7C}
          \definecolor{light_teal}{HTML}{6B8E8E}
          \usepackage{amsmath}
format-links: false
knitr:
  opts_chunk:
    comment: ''
    cache.lazy: FALSE
  opts_knit:
    global.par: TRUE
geometry:
  - top=20mm
  - left=20mm
  - bottom=20mm
  - right=20mm
---

```{css, echo=FALSE}
.cell-output { border-left: #B97C7C 2px solid; border-radius: 0px;}
```


```{r}
#| echo: false
#| warning: false
#| message: false
wd <- "~/projects/seedsarentreal/analyses/methods"
setwd(wd)
util <- new.env()
source('mcmc_analysis_tools_rstan.R', local=util)
source('mcmc_visualization_tools.R', local=util)

library(tikzDevice)
options(tikzLatexPackages = c(getOption("tikzLatexPackages"), "\\definecolor{mid}{HTML}{B97C7C}"))
options(tikzLatexPackages = c(getOption("tikzLatexPackages"), "\\definecolor{light_teal}{HTML}{6B8E8E}"))
options(tikzLatexPackages = c(getOption("tikzLatexPackages"), "\\usepackage{amsmath}"))
options(tikzLatexPackages = c(getOption("tikzLatexPackages"), "\\usepackage{bm}"))
```

# The motivations behind the project

::: {.callout-tip}
## The ecological motivation

Understanding the reproductive behavior that arises at the population level requires to study individual trees' responses. We believe that integrating reproductive biology (i.e. biological **constraints**) and environmental **cues** at the _individual_ level can help us investigating the drivers of the variability and synchronicity of reproduction at the _population_ scale. Our final goal is to understand to what extent climate change could really disrupt forest regeneration---and provide better forecasts!
:::

\

::: {.callout-tip}
## The technical motivation

Bayesian magic! Our approach models the (latent) reproductive states of each _individual_ tree, and the consequent amount of seed production. The states explicitly encode the **constraints** that shape tree reproduction -- in particular, the fact that most trees need at least two years between flower bud differentiation and fruit maturation. We do not standardize away the complexities of individual-level reproduction (e.g. with normalized stand-level indices between 0 and 1...). On the contrary, modeling tree-level reproduction allows us to obtain _population_ estimates -- and thus direct inferences on the population-level variability and synchronicity! And the cherry on top: we incorporate climatic **cues** at different key moments of the reproductive cycle.
:::

\newpage

# The model

## Previous models and limitations

The observations we have---whether for an individual tree or a seed trap---are a time series of yearly seed counts $y_i$.

```{r, fig.height=3, fig.width=7, fig.align="center", dev = 'tikz'}
#| echo: false

par(family="serif", las=1, bty="l",
    cex.axis=0.8, cex.lab=0.85, cex.main=0.85,
    xaxs="i", yaxs="i", mar = c(5, 4, 3, 1))


x <- seq(1,10,2)
y <- rep(0.5, 5)
radii <- rep(0.5, 5)

plot(1, type="n", axes = FALSE, xlab = "", ylab = "",
     xlim=c(0,10), ylim= c(-0.2,1))

arrows(0, 0.1, 10, 0.1, col = 'grey20', lwd=1.2, length = 0.1)
text(5, -0.05, labels = 'Time')

# Add circles: inches=F specifies radius in plot coordinates
symbols(x, y, circles = radii, add = TRUE, inches = FALSE, bg = 'grey90', fg = 'grey40')
# arrows(x[1:4]+0.5, 0.5, x[2:5]-0.5, 0.5, col = 'grey40', lwd=1, length = 0.1)
text(x, y, labels = c('$y_1$', '...', '$y_i$', '$y_{i+1}$', '...'), col = 'grey30')

```

The following quote illustrates the current approach of statistical model of masting:

> ``We fitted a zero-inflated, negative binomial mixed model to the annual number of initiated seeds in each tree, with fixed factors that included summer temperatures in 1 and 2 years before seedfall, [...] and seed production in the previous year to account for possible resource depletion. [...] We included [...] a first-order temporal autocorrelation structure."

If we ignore the zero-inflated part, we could write this model as something like:

$$y_i \sim \text{NegBin}(\mu_i, \phi)$$
$$\mu_i = \alpha + \beta^\text{summer}_{n-1}.X^\text{summer}_{i-1} + \beta^\text{summer}_{n-2}.X^\text{summer}_{i-2} + \beta^\text{seed}_{n-1}.y_{i-1}+ \rho.\epsilon_{i-1}+\epsilon_i$$
$$\epsilon_i \sim \mathcal{N}(0,1)$$
The idea is to introduce some dependency between the seed counts:

```{r, fig.height=3, fig.width=7, fig.align="center", dev = 'tikz'}
#| echo: false

x <- seq(1,10,2)
y <- rep(0.5, 5)
radii <- rep(0.5, 5)

plot(1, type="n", axes = FALSE, xlab = "", ylab = "",
     xlim=c(0,10), ylim= c(-0.2,1))

# Add circles: inches=F specifies radius in plot coordinates
symbols(x, y, circles = radii, add = TRUE, inches = FALSE, bg = 'grey90', fg = 'grey40')
arrows(x[1:4]+0.5, 0.5, x[2:5]-0.5, 0.5, col = 'grey40', lwd=1, length = 0.1)
arrows(x[5]+0.5, 0.5, x[5]+1, 0.5, col = 'grey60', lwd=1, length = 0.05, lty = 3)
arrows(x[5]+0.95, 0.5, x[5]+1, 0.5, col = 'grey60', lwd=1, length = 0.05, lty = 1)
text(x, y, labels = c('$y_1$', '...', '$y_i$', '$y_{i+1}$', '...'), col = 'grey30')


```

The inclusion of both a lagged response of $\beta^\text{seed}_{n-1}.y_{i-1}$ and a first-order autocorrelation structure on the residuals $\rho.\epsilon_{i-1}$ seems... quite tricky.

But more importantly, the effect of summer temperature does not directly depends on the previous state. In other words, whatever the value of $\beta^\text{seed}_{n-1}.y_{i-1}$, a tree that experiences a warm summers would be predicted to have an increasing seed production---regardless of the previous reproductive state. 

```{r, fig.height=6, fig.width=7, fig.align="center", dev = 'tikz'}
#| echo: false

x <- seq(1,10,2)
y <- rep(0.5, 5)
radii <- rep(0.5, 5)

plot(1, type="n", axes = FALSE, xlab = "", ylab = "",
     xlim=c(0,10), ylim= c(-0.2,2))

# Add circles: inches=F specifies radius in plot coordinates
symbols(x, y, circles = radii, add = TRUE, inches = FALSE, bg = 'grey90', fg = 'grey40')
text(x, rep(0.83, 5), labels = c('$\\beta^\\text{summer}_{n-1}.X^\\text{summer}_{0}$', '...', '$\\beta^\\text{summer}_{n-1}.X^\\text{summer}_{i-1}$', '$\\beta^\\text{summer}_{n-1}.X^\\text{summer}_{i}$', '...'), col = 'grey30', cex = 0.85)
arrows(x, 0.77, x, 0.65, col = 'grey40', lwd=1, length = 0.07)
arrows(x[1:4]+0.5, 0.5, x[2:5]-0.5, 0.5, col = 'grey40', lwd=1, length = 0.1)
arrows(x[5]+0.5, 0.5, x[5]+1, 0.5, col = 'grey60', lwd=1, length = 0.05, lty = 3)
arrows(x[5]+0.95, 0.5, x[5]+1, 0.5, col = 'grey60', lwd=1, length = 0.05, lty = 1)
text(x, y, labels = c('$y_1$', '...', '$y_i$', '$y_{i+1}$', '...'), col = 'grey30')

```

This issue arises because we does not explicitly simulate the reproductive state of an individual tree. The model does not allow to differentiate effects of climate during a non-masting year or a masting year. \
Moreover, without modeling individual-level states, it is not possible to infer reproductive behavior at the population scale---including the degree of potential synchrony.

## A new approach grounded in biology

Researchers have worked on the reproductive biology of trees for decades---and in particular fruit trees. In parallel, people working on masting have defined characteristics of masting and developed clear hypotheses about the evolutionary mechanisms that could cause masting. \ 
There is thus a great opportunity to develop more generative models, that explicitly incorporate biological knowledge of flower and fruit development in order to better understand how masting works. 

To understand the reproductive behavior that arises at the population level, we need to model individual trees' reproduction. At the tree level, floral buds are initiated the year before flowering---in the same time as fruits of the current year start developing. During a large crop year (an "on"-year), the presence of many fruits depress flower initiation because of hormonal inhibition and resource trade-off. Thus, the next year will likely be an "off"-year. This behavior is called **alternate bearing**. It is not always a 2-year cycle, as an "on"-year can be followed by several "off"-years. This clearly defines two states for a tree.

```{r, fig.height=3, fig.width=7, fig.align="center", dev = 'tikz'}
#| echo: false

x <- seq(1,10,2)
y <- rep(0.5, 5)
radii <- rep(0.5, 5)

plot(1, type="n", axes = FALSE, xlab = "", ylab = "",
     xlim=c(0,10), ylim= c(-0.2,1))

# Add circles: inches=F specifies radius in plot coordinates
# arrows(x[1]-1, 0.5, x[1]-0.5, 0.5, col = 'grey60', lwd=1, length = 0.05, lty = 3)
# arrows(x[1]-0.55, 0.5, x[1]-0.5, 0.5, col = 'grey60', lwd=1, length = 0.05, lty = 1)
symbols(1, 0.5, circles = 0.5, add = TRUE, inches = FALSE, bg = util$c_light, fg = util$c_mid)
text(1, 0.6, labels = '$z_{1}=$', col = util$c_dark)
text(1, 0.45, labels = 'on-year', col = util$c_dark)
symbols(3, 0.5, circles = 0.5, add = TRUE, inches = FALSE, bg = '#B3C6C6', fg = util$c_mid_teal)
text(3, 0.5, labels = '...', col = util$c_dark_teal)
symbols(5, 0.5, circles = 0.5, add = TRUE, inches = FALSE, bg = '#B3C6C6', fg = util$c_mid_teal)
text(5, 0.6, labels = '$z_i=$', col = util$c_dark_teal)
text(5, 0.45, labels = 'off-year', col = util$c_dark_teal)
symbols(7, 0.5, circles = 0.5, add = TRUE, inches = FALSE, bg = util$c_light, fg = util$c_mid)
text(7, 0.6, labels = '$z_{i+1}=$', col = util$c_dark)
text(7, 0.45, labels = 'on-year', col = util$c_dark)
symbols(9, 0.5, circles = 0.5, add = TRUE, inches = FALSE, bg = '#B3C6C6', fg = util$c_mid_teal)
text(9, 0.5, labels = '...', col = util$c_dark_teal)
arrows(x[1:4]+0.5, 0.5, x[2:5]-0.5, 0.5, col = 'grey40', lwd=1, length = 0.1)
arrows(x[5]+0.5, 0.5, x[5]+1, 0.5, col = 'grey60', lwd=1, length = 0.05, lty = 3)
arrows(x[5]+0.95, 0.5, x[5]+1, 0.5, col = 'grey60', lwd=1, length = 0.05, lty = 1)

```

Each state $z_{i+1}$ is dependent **only on the preceding state** $z_{i}$.\
So, with some parameters $\theta$, the probability of observing some sequences of the two first states is:
$$p(z_1, z_2 ~ | ~\theta) = p(z_1) \times p(z_2 ~ | ~ z_1,\theta)$$
And then, adding the next state:
$$p(z_1, z_2, z_3 ~ | ~\theta) = p(z_1) \times p(z_2 ~ | ~ z_1,\theta) \times p(z_3 ~ | ~ z_2, \theta)$$
And so on...

Each observed seed count at each step arises from the state of the tree. 

```{r, fig.height=5, fig.width=7, fig.align="center", dev = 'tikz'}
#| echo: false

x <- seq(1,10,2)
y <- rep(0.9, 5)
radii <- rep(0.5, 5)

plot(1, type="n", axes = FALSE, xlab = "", ylab = "",
     xlim=c(0,10), ylim= c(-0.2,1.5))

# Add circles: inches=F specifies radius in plot coordinates
# arrows(x[1]-1, 0.5, x[1]-0.5, 0.5, col = 'grey60', lwd=1, length = 0.05, lty = 3)
# arrows(x[1]-0.55, 0.5, x[1]-0.5, 0.5, col = 'grey60', lwd=1, length = 0.05, lty = 1)
symbols(1, 0.5, circles = 0.5, add = TRUE, inches = FALSE, bg = util$c_light, fg = util$c_mid)
text(1, 0.5, labels = '$z_{1}$', col = util$c_dark)
symbols(3, 0.5, circles = 0.5, add = TRUE, inches = FALSE, bg = '#B3C6C6', fg = util$c_mid_teal)
text(3, 0.5, labels = '...', col = util$c_dark_teal)
symbols(5, 0.5, circles = 0.5, add = TRUE, inches = FALSE, bg = '#B3C6C6', fg = util$c_mid_teal)
text(5, 0.5, labels = '$z_i$', col = util$c_dark_teal)
symbols(7, 0.5, circles = 0.5, add = TRUE, inches = FALSE, bg = util$c_light, fg = util$c_mid)
text(7, 0.5, labels = '$z_{i+1}$', col = util$c_dark)
symbols(9, 0.5, circles = 0.5, add = TRUE, inches = FALSE, bg = '#B3C6C6', fg = util$c_mid_teal)
text(9, 0.5, labels = '...', col = util$c_dark_teal)
arrows(x[1:4]+0.5, 0.5, x[2:5]-0.5, 0.5, col = 'grey40', lwd=1, length = 0.1)
arrows(x[5]+0.5, 0.5, x[5]+1, 0.5, col = 'grey60', lwd=1, length = 0.05, lty = 3)
arrows(x[5]+0.95, 0.5, x[5]+1, 0.5, col = 'grey60', lwd=1, length = 0.05, lty = 1)

symbols(x, y, circles = radii, add = TRUE, inches = FALSE, bg = 'grey90', fg = 'grey40')
text(x, y, labels = c('$y_1$', '...', '$y_i$', '$y_{i+1}$', '...'), col = 'grey30')
arrows(x, 0.65, x, 0.75, col = 'grey40', lwd=1, length = 0.07)

```

This would give us this likelihood for the two first seed counts:

$$p(y_1, y_2, z_1, z_2 ~ | ~\theta) = p(z_1) \, p(y_1 ~ | ~ z_1,\theta) \, p(z_2 ~ | ~ z_1,\theta) \, p(y_2 ~ | ~ z_2,\theta)$$
And for all observations until $i+1$:

$$ p(z_{1}) \, p(y_{1} ~ | ~ z_{1}, \theta) \prod_{k = 2}^{i+1} p(z_{k} ~ | ~ z_{k - 1}, \theta) \, p(y_{k} ~ | ~ z_{k}, \theta).$$
