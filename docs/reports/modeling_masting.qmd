---
title: "Modeling masting"
subtitle: "From individual tree behavior to population-level synchrony"
toc: false
number-sections: true
highlight: pygments
pdf-engine: pdflatex
format:
  html:
    html-math-method: katex
    theme:
      - lux
      - custom.scss
    standalone: true
    embed-resources: true
    code-overflow: wrap
    linkcolor: "#B97C7C"
    fontsize: '11pt'
    code-block-border-left: "#8F2727"
    code-block-bg: "#f8f8f8"
    highlight-style: github
  pdf:
    keep-tex: true
    code-overflow: wrap
    monofont: 'Latin Modern Mono'
    monofontoptions:
      - Scale=0.9
    include-in-header:
      - text: |
          \usepackage{bm}
          \usepackage{xcolor}
          \definecolor{mid}{HTML}{8F2727}
          \definecolor{teal}{HTML}{1D4F4F}
          \usepackage{amsmath}
format-links: false
knitr:
  opts_chunk:
    comment: ''
    cache.lazy: FALSE
  opts_knit:
    global.par: TRUE
geometry:
  - top=20mm
  - left=20mm
  - bottom=20mm
  - right=20mm
---

```{css, echo=FALSE}
.cell-output { border-left: #B97C7C 2px solid; border-radius: 0px;}
```


```{r}
#| echo: false
#| warning: false
#| message: false
wd <- "~/projects/seedsarentreal/analyses/methods"
setwd(wd)
util <- new.env()
source('mcmc_analysis_tools_rstan.R', local=util)
source('mcmc_visualization_tools.R', local=util)

library(tikzDevice)
options(tikzLatexPackages = c(getOption("tikzLatexPackages"), "\\definecolor{mid}{HTML}{B97C7C}"))
options(tikzLatexPackages = c(getOption("tikzLatexPackages"), "\\definecolor{light_teal}{HTML}{6B8E8E}"))
options(tikzLatexPackages = c(getOption("tikzLatexPackages"), "\\usepackage{amsmath}"))
options(tikzLatexPackages = c(getOption("tikzLatexPackages"), "\\usepackage{bm}"))

logit <- function(p){
  return(log(p/(1-p)))
}

invlogit <- function(r){
  return(1/(1+exp(-r)))
}
```

This document focuses on a project Lizzie and I have been working on as a way to model masting for individual trees for one species across sites and we think could be extended with Eléonore's help to work well for stand-level seed trap data across species and sites. I start by outlining the background and approach for this particular model, then get into the math! (The math may look complicated if it's been a few years since your last math class, but it will definitely come back with more immersion in it in January)

# The motivations behind the project

::: {.callout-tip}
## The ecological motivation

Population level patterns such as masting emerge from individual trees' responses. Seed production results from each individual tree's reproductive biology (i.e. biological \textbf{constraints}) and response to the environment (**cues** and `vetos'). Working at the individual-level may allow us to better understand the drivers of the variability and synchronicity of reproduction at the \emph{population} scale. Our final goal is to understand to what extent climate change could really disrupt forest regeneration---and provide better forecasts!
:::

\

::: {.callout-tip}
## The technical motivation

Bayesian magic! Our approach models the (latent) reproductive states of each _individual_ tree, and the consequent amount of seed production. The states explicitly encode the **constraints** that shape tree reproduction -- in particular, the fact that most trees need at least two years between flower bud differentiation and fruit maturation. We do not standardize away the complexities of individual-level reproduction (e.g. with normalized stand-level indices between 0 and 1...). On the contrary, modeling tree-level reproduction allows us to obtain _population_ estimates --- and thus direct inferences on the population-level variability and synchronicity! And the cherry on top: we incorporate climatic **cues** at different key moments of the reproductive cycle.
:::

\newpage

# A generative model for masting

## Previous approaches and limitations

The observations we have---whether for an individual tree or a seed trap---are a time series of yearly seed counts $y_i$.

```{r, fig.height=3, fig.width=7, fig.align="center", dev = 'tikz'}
#| echo: false

par(family="serif", las=1, bty="l",
    cex.axis=0.8, cex.lab=0.85, cex.main=0.85,
    xaxs="i", yaxs="i", mar = c(5, 4, 3, 1))


x <- seq(1,10,2)
y <- rep(0.5, 5)
radii <- rep(0.5, 5)

plot(1, type="n", axes = FALSE, xlab = "", ylab = "",
     xlim=c(0,10), ylim= c(-0.2,1))

arrows(0, 0.1, 10, 0.1, col = 'grey20', lwd=1.2, length = 0.1)
text(5, -0.05, labels = 'Time')

# Add circles: inches=F specifies radius in plot coordinates
symbols(x, y, circles = radii, add = TRUE, inches = FALSE, bg = 'grey90', fg = 'grey40')
# arrows(x[1:4]+0.5, 0.5, x[2:5]-0.5, 0.5, col = 'grey40', lwd=1, length = 0.1)
text(x, y, labels = c('$y_1$', '...', '$y_i$', '$y_{i+1}$', '...'), col = 'grey30')

```

The following quote illustrates one approach of statistical model of masting:

> ``We fitted a zero-inflated, negative binomial mixed model to the annual number of initiated seeds in each tree, with fixed factors that included summer temperatures in 1 and 2 years before seedfall, [...] and seed production in the previous year to account for possible resource depletion. [...] We included [...] a first-order temporal autocorrelation structure."

If we ignore the zero-inflated part, we could write this model as something like:

$$y_i \sim \text{NegBin}(\mu_i, \phi)$$
$$\mu_i = \alpha + \beta^\text{summer}_{n-1}.X^\text{summer}_{i-1} + \beta^\text{summer}_{n-2}.X^\text{summer}_{i-2} + \beta^\text{seed}_{n-1}.y_{i-1}+ \rho.\epsilon_{i-1}+\epsilon_i$$
$$\epsilon_i \sim \mathcal{N}(0,1)$$
The idea is to introduce some dependency between the seed counts:

```{r, fig.height=3, fig.width=7, fig.align="center", dev = 'tikz'}
#| echo: false

x <- seq(1,10,2)
y <- rep(0.5, 5)
radii <- rep(0.5, 5)

plot(1, type="n", axes = FALSE, xlab = "", ylab = "",
     xlim=c(0,10), ylim= c(-0.2,1))

# Add circles: inches=F specifies radius in plot coordinates
symbols(x, y, circles = radii, add = TRUE, inches = FALSE, bg = 'grey90', fg = 'grey40')
arrows(x[1:4]+0.5, 0.5, x[2:5]-0.5, 0.5, col = 'grey40', lwd=1, length = 0.1)
arrows(x[5]+0.5, 0.5, x[5]+1, 0.5, col = 'grey60', lwd=1, length = 0.05, lty = 3)
arrows(x[5]+0.95, 0.5, x[5]+1, 0.5, col = 'grey60', lwd=1, length = 0.05, lty = 1)
text(x, y, labels = c('$y_1$', '...', '$y_i$', '$y_{i+1}$', '...'), col = 'grey30')


```

The inclusion of both a lagged response of $\beta^\text{seed}_{n-1}.y_{i-1}$ and a first-order autocorrelation structure on the residuals $\rho.\epsilon_{i-1}$ seems... quite tricky.

But more importantly, the effect of summer temperature does not directly depends on the previous state. In other words, whatever the value of $\beta^\text{seed}_{n-1}.y_{i-1}$, a tree that experiences a warm summers would be predicted to have an increasing seed production---regardless of the previous reproductive state. 

```{r, fig.height=6, fig.width=7, fig.align="center", dev = 'tikz'}
#| echo: false

x <- seq(1,10,2)
y <- rep(0.5, 5)
radii <- rep(0.5, 5)

plot(1, type="n", axes = FALSE, xlab = "", ylab = "",
     xlim=c(0,10), ylim= c(-0.2,2))

# Add circles: inches=F specifies radius in plot coordinates
symbols(x, y, circles = radii, add = TRUE, inches = FALSE, bg = 'grey90', fg = 'grey40')
text(x, rep(0.83, 5), labels = c('$\\beta^\\text{summer}_{n-1}.X^\\text{summer}_{0}$', '...', '$\\beta^\\text{summer}_{n-1}.X^\\text{summer}_{i-1}$', '$\\beta^\\text{summer}_{n-1}.X^\\text{summer}_{i}$', '...'), col = 'grey30', cex = 0.85)
arrows(x, 0.77, x, 0.65, col = 'grey40', lwd=1, length = 0.07)
arrows(x[1:4]+0.5, 0.5, x[2:5]-0.5, 0.5, col = 'grey40', lwd=1, length = 0.1)
arrows(x[5]+0.5, 0.5, x[5]+1, 0.5, col = 'grey60', lwd=1, length = 0.05, lty = 3)
arrows(x[5]+0.95, 0.5, x[5]+1, 0.5, col = 'grey60', lwd=1, length = 0.05, lty = 1)
text(x, y, labels = c('$y_1$', '...', '$y_i$', '$y_{i+1}$', '...'), col = 'grey30')

```

It's hard to include the effect of the previous summer temperature depending on a tree's previous state because each individual tree could be in a different reproductive state, but the model treats all years for all trees as the same. The model does not allow to differentiate effects of climate during a non-masting year or a masting year. We may be able to address this, however, if we start with a model at the individual tree level. \
From there, we can infer reproductive behavior at the population scale---including the degree of potential synchrony.

## A new approach grounded in biology

Researchers have worked on the reproductive biology of trees for decades---and in particular fruit trees. In parallel, people working on masting have defined characteristics of masting and developed clear hypotheses about the evolutionary mechanisms that could cause masting. \ 
There is thus a great opportunity to develop more generative models, that explicitly incorporate biological knowledge of flower and fruit development in order to better understand how masting works. 

To understand the reproductive behavior that arises at the population level, we need to model individual trees' reproduction. At the tree level, floral buds are initiated the year before flowering---in the same time as fruits of the current year start developing. During a large crop year (an "on"-year), the presence of many fruits depress flower initiation because of hormonal inhibition and resource trade-off. Thus, the next year will likely be an "off"-year. This behavior is called **alternate bearing**. It is not always a 2-year cycle, as an "on"-year can be followed by several "off"-years. This clearly defines two states for a tree.

```{r, fig.height=3, fig.width=7, fig.align="center", dev = 'tikz'}
#| echo: false

x <- seq(1,10,2)
y <- rep(0.5, 5)
radii <- rep(0.5, 5)

plot(1, type="n", axes = FALSE, xlab = "", ylab = "",
     xlim=c(0,10), ylim= c(-0.2,1))

# Add circles: inches=F specifies radius in plot coordinates
# arrows(x[1]-1, 0.5, x[1]-0.5, 0.5, col = 'grey60', lwd=1, length = 0.05, lty = 3)
# arrows(x[1]-0.55, 0.5, x[1]-0.5, 0.5, col = 'grey60', lwd=1, length = 0.05, lty = 1)
symbols(1, 0.5, circles = 0.5, add = TRUE, inches = FALSE, bg = util$c_light, fg = util$c_mid)
text(1, 0.6, labels = '$z_{1}=$', col = util$c_dark)
text(1, 0.45, labels = 'on-year', col = util$c_dark)
symbols(3, 0.5, circles = 0.5, add = TRUE, inches = FALSE, bg = '#B3C6C6', fg = util$c_mid_teal)
text(3, 0.5, labels = '...', col = util$c_dark_teal)
symbols(5, 0.5, circles = 0.5, add = TRUE, inches = FALSE, bg = '#B3C6C6', fg = util$c_mid_teal)
text(5, 0.6, labels = '$z_i=$', col = util$c_dark_teal)
text(5, 0.45, labels = 'off-year', col = util$c_dark_teal)
symbols(7, 0.5, circles = 0.5, add = TRUE, inches = FALSE, bg = util$c_light, fg = util$c_mid)
text(7, 0.6, labels = '$z_{i+1}=$', col = util$c_dark)
text(7, 0.45, labels = 'on-year', col = util$c_dark)
symbols(9, 0.5, circles = 0.5, add = TRUE, inches = FALSE, bg = '#B3C6C6', fg = util$c_mid_teal)
text(9, 0.5, labels = '...', col = util$c_dark_teal)
arrows(x[1:4]+0.5, 0.5, x[2:5]-0.5, 0.5, col = 'grey40', lwd=1, length = 0.1)
arrows(x[5]+0.5, 0.5, x[5]+1, 0.5, col = 'grey60', lwd=1, length = 0.05, lty = 3)
arrows(x[5]+0.95, 0.5, x[5]+1, 0.5, col = 'grey60', lwd=1, length = 0.05, lty = 1)

```

Each state $z_{i+1}$ is dependent **only on the preceding state** $z_{i}$ (which is called the _Markovian_ assumption). These states are latent, because we observe only the seed counts. The model I will describe briefly in the next section is thus called a Hidden Markov Model (HMM): _hidden_ because the states are latent, and _Markov_ because of the Markovian assumption. \
With some parameters $\theta$ (parameters are things like the slope and intercept in your model, here $\theta$ stands in for one or more of them and effectively represents---with just one Greek letter---a lot of the rest of your model), the probability of observing some sequences of the two first states is:
$$p(z_1, z_2 ~ | ~\theta) = p(z_1) \times p(z_2 ~ | ~ z_1,\theta)$$
And then, adding the next state:
$$p(z_1, z_2, z_3 ~ | ~\theta) = p(z_1) \times p(z_2 ~ | ~ z_1,\theta) \times p(z_3 ~ | ~ z_2, \theta)$$
And so on $\ldots$ \
Each observed seed count at each step arises from the state of the tree. 

```{r, fig.height=5, fig.width=7, fig.align="center", dev = 'tikz'}
#| echo: false

x <- seq(1,10,2)
y <- rep(0.9, 5)
radii <- rep(0.5, 5)

plot(1, type="n", axes = FALSE, xlab = "", ylab = "",
     xlim=c(0,10), ylim= c(-0.2,1.5))

# Add circles: inches=F specifies radius in plot coordinates
# arrows(x[1]-1, 0.5, x[1]-0.5, 0.5, col = 'grey60', lwd=1, length = 0.05, lty = 3)
# arrows(x[1]-0.55, 0.5, x[1]-0.5, 0.5, col = 'grey60', lwd=1, length = 0.05, lty = 1)
symbols(1, 0.5, circles = 0.5, add = TRUE, inches = FALSE, bg = util$c_light, fg = util$c_mid)
text(1, 0.5, labels = '$z_{1}$', col = util$c_dark)
symbols(3, 0.5, circles = 0.5, add = TRUE, inches = FALSE, bg = '#B3C6C6', fg = util$c_mid_teal)
text(3, 0.5, labels = '...', col = util$c_dark_teal)
symbols(5, 0.5, circles = 0.5, add = TRUE, inches = FALSE, bg = '#B3C6C6', fg = util$c_mid_teal)
text(5, 0.5, labels = '$z_i$', col = util$c_dark_teal)
symbols(7, 0.5, circles = 0.5, add = TRUE, inches = FALSE, bg = util$c_light, fg = util$c_mid)
text(7, 0.5, labels = '$z_{i+1}$', col = util$c_dark)
symbols(9, 0.5, circles = 0.5, add = TRUE, inches = FALSE, bg = '#B3C6C6', fg = util$c_mid_teal)
text(9, 0.5, labels = '...', col = util$c_dark_teal)
arrows(x[1:4]+0.5, 0.5, x[2:5]-0.5, 0.5, col = 'grey40', lwd=1, length = 0.1)
arrows(x[5]+0.5, 0.5, x[5]+1, 0.5, col = 'grey60', lwd=1, length = 0.05, lty = 3)
arrows(x[5]+0.95, 0.5, x[5]+1, 0.5, col = 'grey60', lwd=1, length = 0.05, lty = 1)

symbols(x, y, circles = radii, add = TRUE, inches = FALSE, bg = 'grey90', fg = 'grey40')
text(x, y, labels = c('$y_1$', '...', '$y_i$', '$y_{i+1}$', '...'), col = 'grey30')
arrows(x, 0.65, x, 0.75, col = 'grey40', lwd=1, length = 0.07)

```

This gives us this likelihood for the two first seed counts:
$$p(y_1, y_2, z_1, z_2 ~ | ~\theta) = p(z_1) \, p(y_1 ~ | ~ z_1,\theta) \, p(z_2 ~ | ~ z_1,\theta) \, p(y_2 ~ | ~ z_2,\theta)$$

And for all observations until $i+1$:
$$ p(y_1, \ldots, y_{i+1}, z_1, \ldots, z_{i+1} ~ | ~\theta) = p(z_{1}) \, p(y_{1} ~ | ~ z_{1}, \theta) \prod_{k = 2}^{i+1} p(z_{k} ~ | ~ z_{k - 1}, \theta) \, p(y_{k} ~ | ~ z_{k}, \theta).$$
So, what parameters do wo have to estimate? 

### Transition between states

Let's look at the part which concerns the latent states. \
First, we need to infer the initial state probability $p(z_{1})$, i.e. the probability that the first year is an \textcolor{mid}{on-year} or an \textcolor{teal}{off-year}. Because we have only two states, $p(z_{1} = \text{\textcolor{mid}{on}}) = 1-p(z_{1} = \text{\textcolor{teal}{off}})$---i.e. we have only one parameter to estimate. \
We also have to infer the probabilities of transition $p(z_{k} ~ | ~ z_{k - 1}, \theta)$. With two states, this corresponds to this transition matrix:

$$
M =
\begin{bmatrix}
p(z_{k} = \text{\textcolor{mid}{on}} ~ | ~ z_{k - 1} = \text{\textcolor{mid}{on}}, \theta) & p(z_{k} = \text{\textcolor{teal}{off}} ~ | ~ z_{k - 1} = \text{\textcolor{mid}{on}}, \theta)  \\
p(z_{k} = \text{\textcolor{mid}{on}} ~ | ~ z_{k - 1} = \text{\textcolor{teal}{off}}, \theta)  & p(z_{k} = \text{\textcolor{teal}{off}} ~ | ~ z_{k - 1} = \text{\textcolor{teal}{off}}, \theta) 
\end{bmatrix}
$$
That we could write as:
$$
M =
\begin{bmatrix}
\tau_{\text{\textcolor{mid}{on}} \rightarrow \text{\textcolor{mid}{on}}} & \tau_{\text{\textcolor{mid}{on}} \rightarrow \text{\textcolor{teal}{off}}} \\
\tau_{\text{\textcolor{teal}{off}} \rightarrow \text{\textcolor{mid}{on}}} & \tau_{\text{\textcolor{teal}{off}} \rightarrow \text{\textcolor{teal}{off}}}
\end{bmatrix}
$$

The probability of assignment of $z_2$ to one of the two states is then obtain with the product:

$$
\begin{bmatrix}
p(z_{2} = \text{\textcolor{mid}{on}}) & p(z_{2} = \text{\textcolor{teal}{off}}) 
\end{bmatrix} = 
\begin{bmatrix}
p(z_{1} = \text{\textcolor{mid}{on}}) & p(z_{1} = \text{\textcolor{teal}{off}}) 
\end{bmatrix} \cdot M
$$

Again, because we have only two states, the transition matrix corresponds to only two parameters, for example:
$$
M =
\begin{bmatrix}
\tau_{\text{\textcolor{mid}{on}} \rightarrow \text{\textcolor{mid}{on}}} & 1-\tau_{\text{\textcolor{mid}{on}} \rightarrow \text{\textcolor{mid}{on}}} \\
\tau_{\text{\textcolor{teal}{off}} \rightarrow \text{\textcolor{mid}{on}}} & 1- \tau_{\text{\textcolor{teal}{off}} \rightarrow \text{\textcolor{mid}{on}}}
\end{bmatrix}
$$

In summary, we have 3 parameters to infer: the initial probability of masting $\tau_0= p(z_{1}=\text{\textcolor{mid}{on}})$, the probability of transitioning from an \textcolor{teal}{off-year} to an \textcolor{mid}{on-year} $\tau_{\text{\textcolor{teal}{off}} \rightarrow \text{\textcolor{mid}{on}}}$, and the probability of staying into an \textcolor{teal}{on-year} state $\tau_{\text{\textcolor{mid}{on}} \rightarrow \text{\textcolor{mid}{on}}}$. 

### Seed production parameters

Now, what about the parameters of the observational model that links the latent state to the observed seed count? 
The seed production depends on the state of the tree. Basically, it's a mixture model between two probability distributions.

If the tree is in an \textcolor{teal}{off-year}, then we model the (likely low) seed count with a zero-inflated negative binomial distribution:
$$
y_i
\left\{
\begin{array}{rl}
= 0, & \text{with probability} ~ \theta\\
\sim \text{NegBin}(\mu_\text{\textcolor{teal}{off}}, \phi_\text{\textcolor{teal}{off}}), & \text{with probability} ~ 1-\theta
\end{array}
\right. .
$$

If the tree is in an \textcolor{mid}{on-year}, then we model the seed count with a negative binomial distribution:
$$y_i \sim \text{NegBin}(\mu_\text{\textcolor{mid}{on}}, \phi_\text{\textcolor{mid}{on}})$$

This mixture of two probability distributions would look like this:
```{r, fig.height=3, fig.width=5, fig.align="center", dev = 'tikz'}
#| echo: false
#| eval: true

set.seed(12345)
par(mar = c(4,4,1,1))

theta <- 0.4
nonmasting <- sapply(1:10000, function(x){
  ifelse(rbinom(1, 1, theta) == 1, 0, MASS::rnegbin(1000, 10, 5))
})
hist(nonmasting, breaks=seq(0,650,l=40), col = '#48757560', border = "white", xlab = 'Number of seeds', main = '', prob = TRUE)
masting <- MASS::rnegbin(10000, 100, 2)
hist(masting[masting < 650], breaks=seq(0,650,l=40), col = "#B97C7C60", border = "white", xlab = 'Number of seeds', main = '', add = TRUE, prob = TRUE)
text(x = 70, y = 0.02, labels = 'off-year', col = util$c_mid_teal, font = 1)
text(x = 200, y = 0.005, labels = 'on-year', col = util$c_mid, font = 1)



```

### Adding climate!

Explicitly modeling reproductive states and the subsequent seed production allows to think more deeply where the different climatic cues should impact the individual reproductive cycles and the population-level masting behavior. 

The states explicitly encode the developmental constraints, i.e. the temporal overlap between floral bud initiation and fruit development, that explain the alternate bearing at the individual level. The transition between the states are controlled by the matrix transition. If the transition matrix stays constant across time, we would have an **homogeneous** HMM. But what if climate controls the transition between the states? \
It's quite easy to include some variations in the transition matrix $M$, to have an **heterogeneous** HMM. For example, rather than having a constant probability $\tau_{\text{\textcolor{teal}{off}} \rightarrow \text{\textcolor{mid}{on}}}$, this probability could vary with the local climate:

$$\text{logit}(~\tau_{\text{\textcolor{teal}{off}} \rightarrow \text{\textcolor{mid}{on}}}\{t\}~) = \text{logit}(\tau_0) + \beta ~ \cdot ~ X_\text{climate}\{t\}$$
\newpage
This would give us this kind of functional form, here with $\beta>0$:
```{r, fig.height=2.5, fig.width=4, fig.align="center", dev = 'tikz'}
#| echo: false

tau0 <- 0.2
beta = 0.3

xclim <- seq(-10,20,0.5)

tau <- invlogit(logit(tau0) + beta*xclim)
  
plot(tau ~ xclim, frame = FALSE, type = 'l', col = util$c_light_highlight, lwd = 2,
     ylab = '$\\tau_{\\text{\\textcolor{teal}{off}} \\rightarrow \\text{\\textcolor{mid}{on}}}$', xlab = '$X_\\text{climate}$',
     ylim = c(-0.01, 1.01))

```

Once the tree is assigned to a state, climate may also impact seed production. The number of seeds in a \textcolor{teal}{off-year} could be seen as a ``background noise", and we would thus prioritize adding some climatic predictors on the seed production of an \textcolor{mid}{on-year}. A simple approach would be to modify the location parameter $\mu_\text{\textcolor{mid}{on}}$ of the negative binomial like:

$$\mu_\text{\textcolor{mid}{on}}\{t\} = \mu_0 + \beta ~ \cdot ~ X_\text{climate}\{t\}$$

Obviously, the covariates $X_\text{climate}$ could be different for the transition probabilities and the seed production.

In summary, we could schematize the model as follow:

```{r, fig.height=5, fig.width=7, fig.align="center", dev = 'tikz'}
#| echo: false

x <- seq(1,10,2)
y <- rep(0.9, 5)
radii <- rep(0.5, 5)

plot(1, type="n", axes = FALSE, xlab = "", ylab = "",
     xlim=c(0,10), ylim= c(-0.2,1.5))

# Add circles: inches=F specifies radius in plot coordinates
# arrows(x[1]-1, 0.5, x[1]-0.5, 0.5, col = 'grey60', lwd=1, length = 0.05, lty = 3)
# arrows(x[1]-0.55, 0.5, x[1]-0.5, 0.5, col = 'grey60', lwd=1, length = 0.05, lty = 1)
symbols(1, 0.5, circles = 0.5, add = TRUE, inches = FALSE, bg = util$c_light, fg = util$c_mid)
text(1, 0.5, labels = '$z_{1}$', col = util$c_dark)
symbols(3, 0.5, circles = 0.5, add = TRUE, inches = FALSE, bg = '#B3C6C6', fg = util$c_mid_teal)
text(3, 0.5, labels = '...', col = util$c_dark_teal)
symbols(5, 0.5, circles = 0.5, add = TRUE, inches = FALSE, bg = '#B3C6C6', fg = util$c_mid_teal)
text(5, 0.5, labels = '$z_i$', col = util$c_dark_teal)
symbols(7, 0.5, circles = 0.5, add = TRUE, inches = FALSE, bg = util$c_light, fg = util$c_mid)
text(7, 0.5, labels = '$z_{i+1}$', col = util$c_dark)
symbols(9, 0.5, circles = 0.5, add = TRUE, inches = FALSE, bg = '#B3C6C6', fg = util$c_mid_teal)
text(9, 0.5, labels = '...', col = util$c_dark_teal)
arrows(x[1:4]+0.5, 0.5, x[2:5]-0.5, 0.5, col = 'grey40', lwd=1, length = 0.1)
arrows(x[5]+0.5, 0.5, x[5]+1, 0.5, col = 'grey60', lwd=1, length = 0.05, lty = 3)
arrows(x[5]+0.95, 0.5, x[5]+1, 0.5, col = 'grey60', lwd=1, length = 0.05, lty = 1)

symbols(x, y, circles = radii, add = TRUE, inches = FALSE, bg = 'grey90', fg = 'grey40')
text(x, y, labels = c('$y_1$', '...', '$y_i$', '$y_{i+1}$', '...'), col = 'grey30')
arrows(x, 0.65, x, 0.75, col = 'grey40', lwd=1, length = 0.07)

text(x[c(1,4)], rep(1.33, 2), labels = c('$\\beta \\cdot X_\\text{climate}\\{t\\}$', '$\\beta \\cdot X_\\text{climate}\\{t\\}$'), col = 'grey30', cex = 0.85)
arrows(x[c(1,4)], 1.27, x[c(1,4)], 1.05, col = 'grey40', lwd=1, length = 0.07, lty = 2)

text(x[1:4]+1, rep(0.1, 4), labels = c('$\\beta \\cdot X_\\text{climate}\\{t\\}$', '...', '$\\beta \\cdot X_\\text{climate}\\{t\\}$', '$\\beta \\cdot X_\\text{climate}\\{t\\}$'), col = 'grey30', cex = 0.85)
arrows(x[1:4]+1, 0.2, x[1:4]+1, 0.5, col = 'grey40', lwd=1, length = 0.07, lty = 2)

```

\newpage

# The case of beech masting dynamics

We applied our model to data collected in England. We have annual seed production time series for 57 trees across 7 populations. The maximum duration is 43 years, but most series are shorter (and contained some missing values). For each observed tree and each year, the model estimates the reproductive state---given the previous state---and the subsequent seed production. Climate is included as an explicit driver of both state transitions (probability matrix), and seed production (number of seeds). From these individual reproductive dynamics, the model allows to scale up to population-level behavior and investigate how climate interacts with biological constraints to impact masting. 

The diagram below illustrates how to interpret the following plots. The red bars correspond to the model predictions.

```{=latex}
\begin{figure}[htbp]
  \centering
  \includegraphics[width=0.5\linewidth]{external_figures/quantiles.pdf}
\end{figure}
```

First, we can check for any inconsistencies between the observed data and the behavior of the posterior predictive distribution (what we call "retrodictive checks"). The histogram below compares the distribution of all observations (black line) to the posterior predictive distribution (the predictions by the model, in red).

```{=latex}
\begin{figure}[hb]
  \centering
  \includegraphics[width=0.65\linewidth]{external_figures/retrodictive_check.pdf}
\end{figure}
```

Everything looks consistent. Next we can explore how consistent the observations and the posterior predictions are for some random trees. 

```{=latex}
\begin{figure}[htbp]
  \centering
  \includegraphics[width=0.84\linewidth]{external_figures/tree_checks.pdf}
\end{figure}
```

The grey bars indicate years with missing observations. A strength of the model is that it still allows to estimate the reproductive state and seed production during those years with missing data.

We can also look at the latent states estimated by the model. Remember: these are _latent_, so we don't have observations (no black lines).

```{=latex}
\begin{figure}[htbp]
  \centering
  \includegraphics[width=0.84\linewidth]{external_figures/tree_states.pdf}
\end{figure}
```

\newpage
Using these tree-level states, we can quantify the percentage of trees in an on-year across the 7 populations. This gives us some quantification of synchrony across all stands.

```{=latex}
\begin{figure}[htbp]
  \centering
  \includegraphics[width=0.7\linewidth]{external_figures/masting_trees.pdf}
\end{figure}
```

We can then examine both within-stand and synchrony between stands. Synchrony within stands is likely more relevant for predator satiation hypothesis, as many seed predators have a limited foraging distance. Here, we examine the temporal dynamics of these two distinct components, so we aggregated observations into 5-year bins.

```{=latex}
\begin{figure}[htbp]
  \centering
  \includegraphics[width=0.75\linewidth]{external_figures/synchrony.pdf}
\end{figure}
```

Because we have only two states, the minimum synchrony is $0.5$, because at least 50\% of the trees are in the same state.  I do not go into detail here about our results related to climate impacts, as I believe they may be less directly relevant to Eléonore's project.

\newpage
These results on synchrony open up many possibilities with the data from Mt Rainier! \
At what level of synchrony does reproduction is enough to offer a real fitness benefit to trees? Does synchrony across stands matter more in Mt Rainier, because stands are likely closer than our English dataset? We will also be able to investigate synchrony within species and across species, and maybe relate the patterns to seed predators. For example, are species that share the same seed predators also more synchronous? Many exciting avenues to explore! \

::: {.callout-note}
Remind that one of the strength of our model is to explicitly incorporate the biological constraints at the individual level that shape population masting dynamics. Thus, we will need to think carefully about these constraints and the reproductive biology of each species. In our case, beech has a 2-year cycle, but some species may have a 3-year cycle that could require to tweak the model.
:::



