% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
\PassOptionsToPackage{dvipsnames,svgnames,x11names}{xcolor}
%
\documentclass[
  letterpaper,
  DIV=11,
  numbers=noendperiod]{scrartcl}

\usepackage{amsmath,amssymb}
\usepackage{iftex}
\ifPDFTeX
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math}
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
\usepackage{lmodern}
\ifPDFTeX\else  
    % xetex/luatex font selection
    \setmonofont[Scale=0.9]{Latin Modern Mono}
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\usepackage[top=20mm,left=20mm,bottom=20mm,right=20mm]{geometry}
\setlength{\emergencystretch}{3em} % prevent overfull lines
\setcounter{secnumdepth}{5}
% Make \paragraph and \subparagraph free-standing
\makeatletter
\ifx\paragraph\undefined\else
  \let\oldparagraph\paragraph
  \renewcommand{\paragraph}{
    \@ifstar
      \xxxParagraphStar
      \xxxParagraphNoStar
  }
  \newcommand{\xxxParagraphStar}[1]{\oldparagraph*{#1}\mbox{}}
  \newcommand{\xxxParagraphNoStar}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
  \let\oldsubparagraph\subparagraph
  \renewcommand{\subparagraph}{
    \@ifstar
      \xxxSubParagraphStar
      \xxxSubParagraphNoStar
  }
  \newcommand{\xxxSubParagraphStar}[1]{\oldsubparagraph*{#1}\mbox{}}
  \newcommand{\xxxSubParagraphNoStar}[1]{\oldsubparagraph{#1}\mbox{}}
\fi
\makeatother


\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}\usepackage{longtable,booktabs,array}
\usepackage{calc} % for calculating minipage widths
% Correct order of tables after \paragraph or \subparagraph
\usepackage{etoolbox}
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
% Allow footnotes in longtable head/foot
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother

\usepackage{bm}
\usepackage{xcolor}
\definecolor{mid}{HTML}{8F2727}
\definecolor{teal}{HTML}{1D4F4F}
\usepackage{amsmath}
\KOMAoption{captions}{tableheading}
\makeatletter
\@ifpackageloaded{tcolorbox}{}{\usepackage[skins,breakable]{tcolorbox}}
\@ifpackageloaded{fontawesome5}{}{\usepackage{fontawesome5}}
\definecolor{quarto-callout-color}{HTML}{909090}
\definecolor{quarto-callout-note-color}{HTML}{0758E5}
\definecolor{quarto-callout-important-color}{HTML}{CC1914}
\definecolor{quarto-callout-warning-color}{HTML}{EB9113}
\definecolor{quarto-callout-tip-color}{HTML}{00A047}
\definecolor{quarto-callout-caution-color}{HTML}{FC5300}
\definecolor{quarto-callout-color-frame}{HTML}{acacac}
\definecolor{quarto-callout-note-color-frame}{HTML}{4582ec}
\definecolor{quarto-callout-important-color-frame}{HTML}{d9534f}
\definecolor{quarto-callout-warning-color-frame}{HTML}{f0ad4e}
\definecolor{quarto-callout-tip-color-frame}{HTML}{02b875}
\definecolor{quarto-callout-caution-color-frame}{HTML}{fd7e14}
\makeatother
\makeatletter
\@ifpackageloaded{caption}{}{\usepackage{caption}}
\AtBeginDocument{%
\ifdefined\contentsname
  \renewcommand*\contentsname{Table of contents}
\else
  \newcommand\contentsname{Table of contents}
\fi
\ifdefined\listfigurename
  \renewcommand*\listfigurename{List of Figures}
\else
  \newcommand\listfigurename{List of Figures}
\fi
\ifdefined\listtablename
  \renewcommand*\listtablename{List of Tables}
\else
  \newcommand\listtablename{List of Tables}
\fi
\ifdefined\figurename
  \renewcommand*\figurename{Figure}
\else
  \newcommand\figurename{Figure}
\fi
\ifdefined\tablename
  \renewcommand*\tablename{Table}
\else
  \newcommand\tablename{Table}
\fi
}
\@ifpackageloaded{float}{}{\usepackage{float}}
\floatstyle{ruled}
\@ifundefined{c@chapter}{\newfloat{codelisting}{h}{lop}}{\newfloat{codelisting}{h}{lop}[chapter]}
\floatname{codelisting}{Listing}
\newcommand*\listoflistings{\listof{codelisting}{List of Listings}}
\makeatother
\makeatletter
\makeatother
\makeatletter
\@ifpackageloaded{caption}{}{\usepackage{caption}}
\@ifpackageloaded{subcaption}{}{\usepackage{subcaption}}
\makeatother

\ifLuaTeX
  \usepackage{selnolig}  % disable illegal ligatures
\fi
\usepackage{bookmark}

\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\urlstyle{same} % disable monospaced font for URLs
\hypersetup{
  pdftitle={Modeling masting},
  colorlinks=true,
  linkcolor={blue},
  filecolor={Maroon},
  citecolor={Blue},
  urlcolor={Blue},
  pdfcreator={LaTeX via pandoc}}


\title{Modeling masting}
\usepackage{etoolbox}
\makeatletter
\providecommand{\subtitle}[1]{% add subtitle to \maketitle
  \apptocmd{\@title}{\par {\large #1 \par}}{}{}
}
\makeatother
\subtitle{From individual tree behavior to population-level synchrony}
\author{}
\date{}

\begin{document}
\maketitle


This document focuses on a project Lizzie and I have been working on as
a way to model masting for individual trees for one species across sites
and we think could be extended with ElÃ©onore's help to work well for
stand-level seed trap data across species and sites. I start by
outlining the background and approach for this particular model, then
get into the math! (The math may look complicated if it's been a few
years since your last math class, but it will definitely come back with
more immersion in it in January)

\section{The motivations behind the
project}\label{the-motivations-behind-the-project}

\begin{tcolorbox}[enhanced jigsaw, arc=.35mm, leftrule=.75mm, opacityback=0, titlerule=0mm, left=2mm, colbacktitle=quarto-callout-tip-color!10!white, bottomrule=.15mm, colback=white, toprule=.15mm, colframe=quarto-callout-tip-color-frame, breakable, opacitybacktitle=0.6, bottomtitle=1mm, coltitle=black, toptitle=1mm, rightrule=.15mm, title=\textcolor{quarto-callout-tip-color}{\faLightbulb}\hspace{0.5em}{The ecological motivation}]

Population level patterns such as masting emerge from individual trees'
responses. Seed production results from each individual tree's
reproductive biology (i.e.~biological \textbf{constraints}) and response
to the environment (\textbf{cues} and `vetos'). Working at the
individual-level may allow us to better understand the drivers of the
variability and synchronicity of reproduction at the \emph{population}
scale. Our final goal is to understand to what extent climate change
could really disrupt forest regeneration---and provide better forecasts!

\end{tcolorbox}

\hfill\break

\begin{tcolorbox}[enhanced jigsaw, arc=.35mm, leftrule=.75mm, opacityback=0, titlerule=0mm, left=2mm, colbacktitle=quarto-callout-tip-color!10!white, bottomrule=.15mm, colback=white, toprule=.15mm, colframe=quarto-callout-tip-color-frame, breakable, opacitybacktitle=0.6, bottomtitle=1mm, coltitle=black, toptitle=1mm, rightrule=.15mm, title=\textcolor{quarto-callout-tip-color}{\faLightbulb}\hspace{0.5em}{The technical motivation}]

Bayesian magic! Our approach models the (latent) reproductive states of
each \emph{individual} tree, and the consequent amount of seed
production. The states explicitly encode the \textbf{constraints} that
shape tree reproduction -- in particular, the fact that most trees need
at least two years between flower bud differentiation and fruit
maturation. We do not standardize away the complexities of
individual-level reproduction (e.g.~with normalized stand-level indices
between 0 and 1\ldots). On the contrary, modeling tree-level
reproduction allows us to obtain \emph{population} estimates --- and
thus direct inferences on the population-level variability and
synchronicity! And the cherry on top: we incorporate climatic
\textbf{cues} at different key moments of the reproductive cycle.

\end{tcolorbox}

\newpage

\section{A generative model for
masting}\label{a-generative-model-for-masting}

\subsection{Previous approaches and
limitations}\label{previous-approaches-and-limitations}

The observations we have---whether for an individual tree or a seed
trap---are a time series of yearly seed counts \(y_i\).

\begin{center}
\includegraphics{modeling_masting_files/figure-pdf/unnamed-chunk-3-1.pdf}
\end{center}

The following quote illustrates one approach of statistical model of
masting:

\begin{quote}
``We fitted a zero-inflated, negative binomial mixed model to the annual
number of initiated seeds in each tree, with fixed factors that included
summer temperatures in 1 and 2 years before seedfall, {[}\ldots{]} and
seed production in the previous year to account for possible resource
depletion. {[}\ldots{]} We included {[}\ldots{]} a first-order temporal
autocorrelation structure.''
\end{quote}

If we ignore the zero-inflated part, we could write this model as
something like:

\[y_i \sim \text{NegBin}(\mu_i, \phi)\]
\[\mu_i = \alpha + \beta^\text{summer}_{n-1}.X^\text{summer}_{i-1} + \beta^\text{summer}_{n-2}.X^\text{summer}_{i-2} + \beta^\text{seed}_{n-1}.y_{i-1}+ \rho.\epsilon_{i-1}+\epsilon_i\]
\[\epsilon_i \sim \mathcal{N}(0,1)\] The idea is to introduce some
dependency between the seed counts:

\begin{center}
\includegraphics{modeling_masting_files/figure-pdf/unnamed-chunk-4-1.pdf}
\end{center}

The inclusion of both a lagged response of
\(\beta^\text{seed}_{n-1}.y_{i-1}\) and a first-order autocorrelation
structure on the residuals \(\rho.\epsilon_{i-1}\) seems\ldots{} quite
tricky.

But more importantly, the effect of summer temperature does not directly
depends on the previous state. In other words, whatever the value of
\(\beta^\text{seed}_{n-1}.y_{i-1}\), a tree that experiences a warm
summers would be predicted to have an increasing seed
production---regardless of the previous reproductive state.

\begin{center}
\includegraphics{modeling_masting_files/figure-pdf/unnamed-chunk-5-1.pdf}
\end{center}

It's hard to include the effect of the previous summer temperature
depending on a tree's previous state because each individual tree could
be in a different reproductive state, but the model treats all years for
all trees as the same. The model does not allow to differentiate effects
of climate during a non-masting year or a masting year. We may be able
to address this, however, if we start with a model at the individual
tree level.\\
From there, we can infer reproductive behavior at the population
scale---including the degree of potential synchrony.

\subsection{A new approach grounded in
biology}\label{a-new-approach-grounded-in-biology}

Researchers have worked on the reproductive biology of trees for
decades---and in particular fruit trees. In parallel, people working on
masting have defined characteristics of masting and developed clear
hypotheses about the evolutionary mechanisms that could cause masting. ~
There is thus a great opportunity to develop more generative models,
that explicitly incorporate biological knowledge of flower and fruit
development in order to better understand how masting works.

To understand the reproductive behavior that arises at the population
level, we need to model individual trees' reproduction. At the tree
level, floral buds are initiated the year before flowering---in the same
time as fruits of the current year start developing. During a large crop
year (an ``on''-year), the presence of many fruits depress flower
initiation because of hormonal inhibition and resource trade-off. Thus,
the next year will likely be an ``off''-year. This behavior is called
\textbf{alternate bearing}. It is not always a 2-year cycle, as an
``on''-year can be followed by several ``off''-years. This clearly
defines two states for a tree.

\begin{center}
\includegraphics{modeling_masting_files/figure-pdf/unnamed-chunk-6-1.pdf}
\end{center}

Each state \(z_{i+1}\) is dependent \textbf{only on the preceding state}
\(z_{i}\) (which is called the \emph{Markovian} assumption). These
states are latent, because we observe only the seed counts. The model I
will describe briefly in the next section is thus called a Hidden Markov
Model (HMM): \emph{hidden} because the states are latent, and
\emph{Markov} because of the Markovian assumption.\\
With some parameters \(\theta\) (parameters are things like the slope
and intercept in your model, here \(\theta\) stands in for one or more
of them and effectively represents---with just one Greek letter---a lot
of the rest of your model), the probability of observing some sequences
of the two first states is:
\[p(z_1, z_2 ~ | ~\theta) = p(z_1) \times p(z_2 ~ | ~ z_1,\theta)\] And
then, adding the next state:
\[p(z_1, z_2, z_3 ~ | ~\theta) = p(z_1) \times p(z_2 ~ | ~ z_1,\theta) \times p(z_3 ~ | ~ z_2, \theta)\]
And so on \(\ldots\)\\
Each observed seed count at each step arises from the state of the tree.

\begin{center}
\includegraphics{modeling_masting_files/figure-pdf/unnamed-chunk-7-1.pdf}
\end{center}

This gives us this likelihood for the two first seed counts:
\[p(y_1, y_2, z_1, z_2 ~ | ~\theta) = p(z_1) \, p(y_1 ~ | ~ z_1,\theta) \, p(z_2 ~ | ~ z_1,\theta) \, p(y_2 ~ | ~ z_2,\theta)\]

And for all observations until \(i+1\):
\[ p(y_1, \ldots, y_{i+1}, z_1, \ldots, z_{i+1} ~ | ~\theta) = p(z_{1}) \, p(y_{1} ~ | ~ z_{1}, \theta) \prod_{k = 2}^{i+1} p(z_{k} ~ | ~ z_{k - 1}, \theta) \, p(y_{k} ~ | ~ z_{k}, \theta).\]
So, what parameters do wo have to estimate?

\subsubsection{Transition between
states}\label{transition-between-states}

Let's look at the part which concerns the latent states.\\
First, we need to infer the initial state probability \(p(z_{1})\),
i.e.~the probability that the first year is an \textcolor{mid}{on-year}
or an \textcolor{teal}{off-year}. Because we have only two states,
\(p(z_{1} = \text{\textcolor{mid}{on}}) = 1-p(z_{1} = \text{\textcolor{teal}{off}})\)---i.e.~we
have only one parameter to estimate.\\
We also have to infer the probabilities of transition
\(p(z_{k} ~ | ~ z_{k - 1}, \theta)\). With two states, this corresponds
to this transition matrix:

\[
M =
\begin{bmatrix}
p(z_{k} = \text{\textcolor{mid}{on}} ~ | ~ z_{k - 1} = \text{\textcolor{mid}{on}}, \theta) & p(z_{k} = \text{\textcolor{teal}{off}} ~ | ~ z_{k - 1} = \text{\textcolor{mid}{on}}, \theta)  \\
p(z_{k} = \text{\textcolor{mid}{on}} ~ | ~ z_{k - 1} = \text{\textcolor{teal}{off}}, \theta)  & p(z_{k} = \text{\textcolor{teal}{off}} ~ | ~ z_{k - 1} = \text{\textcolor{teal}{off}}, \theta) 
\end{bmatrix}
\] That we could write as: \[
M =
\begin{bmatrix}
\tau_{\text{\textcolor{mid}{on}} \rightarrow \text{\textcolor{mid}{on}}} & \tau_{\text{\textcolor{mid}{on}} \rightarrow \text{\textcolor{teal}{off}}} \\
\tau_{\text{\textcolor{teal}{off}} \rightarrow \text{\textcolor{mid}{on}}} & \tau_{\text{\textcolor{teal}{off}} \rightarrow \text{\textcolor{teal}{off}}}
\end{bmatrix}
\]

The probability of assignment of \(z_2\) to one of the two states is
then obtain with the product:

\[
\begin{bmatrix}
p(z_{2} = \text{\textcolor{mid}{on}}) & p(z_{2} = \text{\textcolor{teal}{off}}) 
\end{bmatrix} = 
\begin{bmatrix}
p(z_{1} = \text{\textcolor{mid}{on}}) & p(z_{1} = \text{\textcolor{teal}{off}}) 
\end{bmatrix} \cdot M
\]

Again, because we have only two states, the transition matrix
corresponds to only two parameters, for example: \[
M =
\begin{bmatrix}
\tau_{\text{\textcolor{mid}{on}} \rightarrow \text{\textcolor{mid}{on}}} & 1-\tau_{\text{\textcolor{mid}{on}} \rightarrow \text{\textcolor{mid}{on}}} \\
\tau_{\text{\textcolor{teal}{off}} \rightarrow \text{\textcolor{mid}{on}}} & 1- \tau_{\text{\textcolor{teal}{off}} \rightarrow \text{\textcolor{mid}{on}}}
\end{bmatrix}
\]

In summary, we have 3 parameters to infer: the initial probability of
masting \(\tau_0= p(z_{1}=\text{\textcolor{mid}{on}})\), the probability
of transitioning from an \textcolor{teal}{off-year} to an
\textcolor{mid}{on-year}
\(\tau_{\text{\textcolor{teal}{off}} \rightarrow \text{\textcolor{mid}{on}}}\),
and the probability of staying into an \textcolor{teal}{on-year} state
\(\tau_{\text{\textcolor{mid}{on}} \rightarrow \text{\textcolor{mid}{on}}}\).

\subsubsection{Seed production
parameters}\label{seed-production-parameters}

Now, what about the parameters of the observational model that links the
latent state to the observed seed count? The seed production depends on
the state of the tree. Basically, it's a mixture model between two
probability distributions.

If the tree is in an \textcolor{teal}{off-year}, then we model the
(likely low) seed count with a zero-inflated negative binomial
distribution: \[
y_i
\left\{
\begin{array}{rl}
= 0, & \text{with probability} ~ \theta\\
\sim \text{NegBin}(\mu_\text{\textcolor{teal}{off}}, \phi_\text{\textcolor{teal}{off}}), & \text{with probability} ~ 1-\theta
\end{array}
\right. .
\]

If the tree is in an \textcolor{mid}{on-year}, then we model the seed
count with a negative binomial distribution:
\[y_i \sim \text{NegBin}(\mu_\text{\textcolor{mid}{on}}, \phi_\text{\textcolor{mid}{on}})\]

This mixture of two probability distributions would look like this:

\begin{center}
\includegraphics{modeling_masting_files/figure-pdf/unnamed-chunk-8-1.pdf}
\end{center}

\subsubsection{Adding climate!}\label{adding-climate}

Explicitly modeling reproductive states and the subsequent seed
production allows to think more deeply where the different climatic cues
should impact the individual reproductive cycles and the
population-level masting behavior.

The states explicitly encode the developmental constraints, i.e.~the
temporal overlap between floral bud initiation and fruit development,
that explain the alternate bearing at the individual level. The
transition between the states are controlled by the matrix transition.
If the transition matrix stays constant across time, we would have an
\textbf{homogeneous} HMM. But what if climate controls the transition
between the states?\\
It's quite easy to include some variations in the transition matrix
\(M\), to have an \textbf{heterogeneous} HMM. For example, rather than
having a constant probability
\(\tau_{\text{\textcolor{teal}{off}} \rightarrow \text{\textcolor{mid}{on}}}\),
this probability could vary with the local climate:

\[\text{logit}(~\tau_{\text{\textcolor{teal}{off}} \rightarrow \text{\textcolor{mid}{on}}}\{t\}~) = \text{logit}(\tau_0) + \beta ~ \cdot ~ X_\text{climate}\{t\}\]
\newpage This would give us this kind of functional form, here with
\(\beta>0\):

\begin{center}
\includegraphics{modeling_masting_files/figure-pdf/unnamed-chunk-9-1.pdf}
\end{center}

Once the tree is assigned to a state, climate may also impact seed
production. The number of seeds in a \textcolor{teal}{off-year} could be
seen as a ``background noise'', and we would thus prioritize adding some
climatic predictors on the seed production of an
\textcolor{mid}{on-year}. A simple approach would be to modify the
location parameter \(\mu_\text{\textcolor{mid}{on}}\) of the negative
binomial like:

\[\mu_\text{\textcolor{mid}{on}}\{t\} = \mu_0 + \beta ~ \cdot ~ X_\text{climate}\{t\}\]

Obviously, the covariates \(X_\text{climate}\) could be different for
the transition probabilities and the seed production.

In summary, we could schematize the model as follow:

\begin{center}
\includegraphics{modeling_masting_files/figure-pdf/unnamed-chunk-10-1.pdf}
\end{center}

\newpage

\section{The case of beech masting
dynamics}\label{the-case-of-beech-masting-dynamics}

We applied our model to data collected in England. We have annual seed
production time series for 57 trees across 7 sites. The maximum duration
is 43 years, but most series are shorter (and contained some missing
values). For each observed tree and each year, the model estimates the
reproductive state---given the previous state---and the subsequent seed
production. Climate is included as an explicit driver of both state
transitions (probability matrix), and seed production (number of seeds).
From these individual reproductive dynamics, the model allows to scale
up to population-level behavior and investigate how climate interacts
with biological constraints to impact masting.

The diagram below illustrates how to interpret the following plots. The
red bars correspond to the model predictions.

\begin{figure}[htbp]
  \centering
  \includegraphics[width=0.5\linewidth]{external_figures/quantiles.pdf}
\end{figure}

First, we can check for any inconsistencies between the observed data
and the behavior of the posterior predictive distribution (what we call
``retrodictive checks''). The histogram below compares the distribution
of all observations (black line) to the posterior predictive
distribution (the predictions by the model, in red).

\begin{figure}[hb]
  \centering
  \includegraphics[width=0.65\linewidth]{external_figures/retrodictive_check.pdf}
\end{figure}

Everything looks consistent. Next we can explore how consistent the
observations and the posterior predictions are for some random trees.

\begin{figure}[htbp]
  \centering
  \includegraphics[width=0.82\linewidth]{external_figures/tree_checks.pdf}
\end{figure}

The grey bars indicate years with missing observations. A strength of
the model is that it still allows to estimate the reproductive state and
seed production during those years with missing data.

We can also look at the latent states that are estimated by the model.
Remember: these are \emph{latent}, so we don't have observations (no
black lines).

\begin{figure}[htbp]
  \centering
  \includegraphics[width=0.82\linewidth]{external_figures/tree_states.pdf}
\end{figure}




\end{document}
